name: Update AUR Package - zen-browser-avx2-bin-git

on:
  workflow_dispatch:

jobs:
  update_version:
    runs-on: ubuntu-latest
    outputs:
      need_update: ${{ steps.check_version.outputs.need_update}}
      latest_version: ${{ steps.check_version.outputs.latest_version}}
    steps:
      - uses: actions/checkout@v3
      - name: Check if update is required
        id: check_version
        run: | 
          LATEST_VERSION=$(curl -s https://api.github.com/repos/zen-browser/desktop/git/refs/tags/twilight | jq -r '.object.sha' | cut -c1-7)
          echo "Latest version is currently $LATEST_VERSION"
          echo "test"
          CURRENT_VERSION=$(curl -s https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD?h=zen-browser-avx2-bin-git | grep -oP '^pkgver=\K.*')
          echo "Current version is current $CURRENT_VERSION"
          
          if [[ "$LATEST_VERSION" != "$CURRENT_VERSION" ]]; then
            echo "need_update=true" >> "$GITHUB_OUTPUT"
          else
            echo "need_update=false" >> "$GITHUB_OUTPUT"
          fi
          
          echo "latest_version=$LATEST_VERSION" >> "$GITHUB_OUTPUT";
          echo "current_version=$CURRENT_VERSION" >> "$GITHUB_OUTPUT";
      - name: Update PKGBUILD
        if: steps.check_version.outputs.need_update == 'true'
        run: |
          sed "s/PACKAGE_VERSION/${latest_version}/g" template/avx2/SRCINFO_avx2_template > avx2/.SRCINFO
          sed "s/PACKAGE_VERSION/${latest_version}/g" template/avx2/PKGBUILD_avx2_template > avx2/PKGBUILD
      - name: Upload to AUR
        if: steps.check_version.outputs.need_update == 'true'
        run: |
          cat avx2/PKGBUILD
          cat avx2/.SRCINFO
          
  # aur-release:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v3

  #     - run: PACKAGE_VERSION=$(curl -s https://api.github.com/repos/zen-browser/desktop/git/refs/tags/twilight | jq -r '.object.sha' | cut -c1-7) && echo "package_version=$PACKAGE_VERSION" >> $GITHUB_ENV
  #     - run: sed "s/PACKAGE_VERSION/${package_version}/g" template/avx2/PKGBUILD_avx2_template > avx2/PKGBUILD
